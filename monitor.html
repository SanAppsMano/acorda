<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Monitor</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    a { display: inline-block; margin: 1rem 0; padding: 1rem 2rem; background: #007acc; color: white; text-decoration: none; border-radius: 0.5rem; }
    button { padding: 1rem 2rem; font-size: 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Inscrição via Link</h1>
  <p>Clique no link abaixo em seu celular para ativar notificações:</p>
  <a href="/subscribe.html" target="_blank">Ativar alertas</a>
  <div id="qr" style="margin: 1rem auto; width:200px; height:200px;"></div>
  <p>Após a inscrição, no monitor você poderá acordar todos os inscritos.</p>
  <p id="countInfo">Carregando inscrições...</p>
  <button id="wakeBtn">Acorde todos os inscritos</button>

  <script src="./lib/qrcode.min.js"></script>
  <script>
    async function updateCount() {
      try {
        const res = await fetch('/.netlify/functions/getSubs');
        const data = await res.json();
        document.getElementById('countInfo').textContent =
          `Inscrições ativas: ${data.count}`;
      } catch (err) {
        document.getElementById('countInfo').textContent =
          'Não foi possível carregar as inscrições.';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateCount();
      const url = window.location.origin + "/subscribe.html";
      const container = document.getElementById('qr');

      if (typeof QRCode === 'function') {
        // Biblioteca qrcodejs
        new QRCode(container, {
          text: url,
          width: 200,
          height: 200
        });
      } else if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
        // Fallback para biblioteca qrcode do Node
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        QRCode.toCanvas(canvas, url, { width: 200 }, (err) => {
          if (err) console.error('Erro ao gerar QR:', err);
        });
      } else {
        console.error('Biblioteca QRCode não carregada');
      }
      document.getElementById('wakeBtn').addEventListener('click', async () => {
        try {
        const res = await fetch('/.netlify/functions/sendPush', { method: 'POST' });
        const data = await res.json();
        console.log(data);
        if (data.message) {
          alert(data.message);
        } else {
          alert('Notificações enviadas!');
        }
        updateCount();
        } catch (err) {
          console.error(err);
          alert('Erro ao enviar notificações');
        }
      });
    });
  </script>
</body>
</html>
